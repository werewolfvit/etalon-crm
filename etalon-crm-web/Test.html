<!DOCTYPE html>
<html>
<head>
    <title>Test</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script type="text/javascript" src="/Scripts/ext-all-rtl-debug.js"></script>
    <link rel="stylesheet" href="/Content/CSS/theme-neptune-all_1.css"/>
    <link rel="stylesheet" href="/Content/CSS/theme-neptune-all_2.css" />
</head>
<body>
<script type="text/javascript">
    
    Ext.define("mainMenuForm",
    {
        renderTo: Ext.getBody(),
        extend: 'Ext.container.Container',
        layout: {
            type: 'vbox'
        },
        //layout: {
        //    type: 'table',
        //    columns: 2,
        //    tdAttrs: { style: 'padding: 10px;' }
        //},

        //defaults: {
        //    xtype: 'panel',
        //    height: 220,
        //    width: 220,
        //    bodyPadding: 10
        //},
        //width: 480,

        

        initComponent: function () {
            this.items = [
                {
                    title: 'Left',
                    xtype: 'panel',
                    dockedItems: [{
                        dock: 'left',
                        xtype: 'toolbar',
                        items: [{
                            iconCls: null,
                            glyph: 61,
                            xtype: 'button'
                        }, '-', {
                            iconCls: null,
                            glyph: 88,
                            xtype: 'button'
                        }, {
                            iconCls: null,
                            glyph: 70,
                            xtype: 'button'
                        }, '-', {
                            iconCls: null,
                            glyph: 47,
                            xtype: 'button'
                        }]
                    }],
                    html: 'Lorem ipsum dolor sit amet, consectetur adipiscing elit.'
                }
            ];

            this.callParent();
        }
    });

    Ext.define('loginForm',
    {
        extend: 'Ext.window.Window',
        renderTo: Ext.getBody(),
        requires: 'Ext.form.Panel',
        bodyPagging: 10,
        title: 'Etalon CRM: вход в систему',
        closable: false,
        autoShow: true,
        resizable: false,
        draggable: false,

        items: {
            xtype: 'form',
            //reference: 'form',
            items: [
                {
                    xtype: 'textfield',
                    name: 'login',
                    fieldLabel: 'Логин:',
                    allowBlank: false,
                    margin: "10 5 0 5"
                }, {
                    xtype: 'textfield',
                    name: 'password',
                    inputType: 'password',
                    fieldLabel: 'Пароль:',
                    allowBlank: false,
                    margin: "10 5 10 5"
                }, {
                    xtype: "checkboxfield",
                    name: "remember",
                    fieldLabel: "Запомнить меня",
                    checked: true,
                    margin: "10 5 10 5",
                    inputValue: true,
                    uncheckedValue: false
                }
            ],
            buttons: [
                {
                    text: 'Войти',
                    formBind: true,
                    listeners: {
                        click: function(btn) {
                            var form = btn.up('form').getForm();

                            Ext.Ajax.request({
                                url: "API/Auth/Login",
                                method: "POST",
                                jsonData: form.getValues(),
                                success: function(response, opts) {
                                    var obj = Ext.decode(response.responseText);
                                    if (obj.Status === 'Error') {
                                        Ext.example.msg('Не удалось войти', '<b>Неверная пара логин\\пароль!</b>');
                                        Ext.Msg.alert('Не удалось войти', '<b>Неверная пара логин\\пароль!</b>', Ext.emptyFn);
                                    } else {
                                        var wnd = btn.up('window');
                                        wnd.close();
                                        Ext.create('mainMenuForm');
                                    }
                                },
                                failure: function () {
                                    Ext.Msg.alert('Сервер недоступен', 'Сервер не отвечает, обратитесь к администратору.', Ext.emptyFn);
                                    Ext.example.msg('Сервер недоступен', 'Сервер не отвечает, обратитесь к администратору.');
                                }
                            });
                        }
                    }
                }
            ]
        }
    });



    Ext.application({
        name: 'MyApp',

        launch: function() {
            /*
            1. Проверяем авторизованны ли мы, если да, кидаем на главную, если нет - кидаем на форму логина.
            2. С главной можно выйти.
            3. С логина можно залогиниться.
            */

            Ext.Ajax.request({
                url: "API/Auth/GetUserInfo",
                success: function(response, opts) {
                    var obj = Ext.decode(response.responseText);
                    if (obj.Status === 'Error') {
                        Ext.create("loginForm");
                    } else {
                        Ext.create("mainMenuForm");
                    }
                },
                failure: function(response, opts) {
                    console.log("server fault: " + response.status);
                }
            });
        }
    });

    /*
    var store = Ext.create('Ext.data.Store', {
        fields: ['title','phone', 'email'],
        data: [
            { 'title': 'Marry An', 'phone': '888', 'email': 'marry@mail.com' },
            { 'title': 'Marry An2', 'phone': '8882', 'email': 'marry@mail.com2' },
            { 'title': 'Marry An3', 'phone': '8883', 'email': 'marry@mail.com3' },
            { 'title': 'Marry An11', 'phone': '88811', 'email': 'marry@mail.com11' },
            { 'title': 'Marry An112', 'phone': '888112', 'email': 'marry@mail.com112' },
            { 'title': 'Marry An113', 'phone': '888113', 'email': 'marry@mail.com113' },
        ]
    });

    Ext.create('Ext.container.Viewport',
    {
        title: 'LOL - GRID',
        
        layout: 'fit',
        fullscreen: true,
        height: 200,
        items: [
            {
                xtype: 'grid',
                columns: [
                    { text: 'Title', dataIndex: 'title', width: 250 },
                    { text: 'Phone', dataIndex: 'phone', width: 250 },
                    { text: 'Email', dataIndex: 'email', width: 250 }
                ],
                store : store
            }
        ]
    }); */

</script>
</body>
</html>
